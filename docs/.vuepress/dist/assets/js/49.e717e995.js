(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{404:function(t,s,a){"use strict";a.r(s);var n=a(42),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"encryption"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#encryption"}},[t._v("#")]),t._v(" Encryption")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#encryption"}},[t._v("Encryption")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#bootstrap-process"}},[t._v("Bootstrap Process")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#consensus_seed"}},[a("code",[t._v("consensus_seed")])])]),t._v(" "),a("li",[a("a",{attrs:{href:"#key-derivation"}},[t._v("Key Derivation")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#consensus_seed_exchange_privkey"}},[a("code",[t._v("consensus_seed_exchange_privkey")])])]),t._v(" "),a("li",[a("a",{attrs:{href:"#consensus_io_exchange_privkey"}},[a("code",[t._v("consensus_io_exchange_privkey")])])]),t._v(" "),a("li",[a("a",{attrs:{href:"#consensus_state_ikm"}},[a("code",[t._v("consensus_state_ikm")])])]),t._v(" "),a("li",[a("a",{attrs:{href:"#consensus_callback_secret"}},[a("code",[t._v("consensus_callback_secret")])])])])]),t._v(" "),a("li",[a("a",{attrs:{href:"#bootstrap-process-epilogue"}},[t._v("Bootstrap Process Epilogue")])])])]),t._v(" "),a("li",[a("a",{attrs:{href:"#node-startup"}},[t._v("Node Startup")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#new-node-registration"}},[t._v("New Node Registration")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#on-the-new-node"}},[t._v("On the new node")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#on-the-consensus-layer-inside-the-enclave-of-every-full-node"}},[t._v("On the consensus layer, inside the Enclave of every full node")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#seed_exchange_key"}},[a("code",[t._v("seed_exchange_key")])])]),t._v(" "),a("li",[a("a",{attrs:{href:"#sharing-consensus_seed-with-the-new-node"}},[t._v("Sharing "),a("code",[t._v("consensus_seed")]),t._v(" with the new node")])])])]),t._v(" "),a("li",[a("a",{attrs:{href:"#back-on-the-new-node-inside-its-enclave"}},[t._v("Back on the new node, inside its Enclave")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#seed_exchange_key-1"}},[a("code",[t._v("seed_exchange_key")])])]),t._v(" "),a("li",[a("a",{attrs:{href:"#decrypting-encrypted_consensus_seed"}},[t._v("Decrypting "),a("code",[t._v("encrypted_consensus_seed")])])])])]),t._v(" "),a("li",[a("a",{attrs:{href:"#new-node-registration-epilogue"}},[t._v("New Node Registration Epilogue")])])])]),t._v(" "),a("li",[a("a",{attrs:{href:"#contracts-state-encryption"}},[t._v("Contracts State Encryption")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#contract_key"}},[a("code",[t._v("contract_key")])])]),t._v(" "),a("li",[a("a",{attrs:{href:"#write_dbfield_name-value"}},[t._v("write_db(field_name, value)")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#read_dbfield_name"}},[t._v("read_db(field_name)")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#remove_dbfield_name"}},[t._v("remove_db(field_name)")])])])]),t._v(" "),a("li",[a("a",{attrs:{href:"#transaction-encryption"}},[t._v("Transaction Encryption")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#input"}},[t._v("Input")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#on-the-transaction-sender"}},[t._v("On the transaction sender")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#on-the-consensus-layer-inside-the-enclave-of-every-full-node-1"}},[t._v("On the consensus layer, inside the Enclave of every full node")])])])]),t._v(" "),a("li",[a("a",{attrs:{href:"#output"}},[t._v("Output")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#on-the-consensus-layer-inside-the-enclave-of-every-full-node-2"}},[t._v("On the consensus layer, inside the Enclave of every full node")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#back-on-the-transaction-sender"}},[t._v("Back on the transaction sender")])])])])])]),t._v(" "),a("li",[a("a",{attrs:{href:"#blockchain-upgrades"}},[t._v("Blockchain Upgrades")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#theoretical-attacks"}},[t._v("Theoretical Attacks")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#deanonymizing-with-ciphertext-byte-count"}},[t._v("Deanonymizing with ciphertext byte count")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#two-contracts-with-the-same-contract_key-could-deanonymize-each-others-states"}},[t._v("Two contracts with the same "),a("code",[t._v("contract_key")]),t._v(" could deanonymize each other's states")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#tx-replay-attacks"}},[t._v("Tx Replay attacks")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#more-advanced-tx-replay-attacks----search-to-decision-for-millionaires-problem"}},[t._v("More Advanced Tx Replay attacks -- search to decision for Millionaire's problem")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#partial-storage-rollback-during-contract-runtime"}},[t._v("Partial storage rollback during contract runtime")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#tx-outputs-can-leak-data"}},[t._v("Tx outputs can leak data")])])])])]),t._v(" "),a("h1",{attrs:{id:"bootstrap-process"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bootstrap-process"}},[t._v("#")]),t._v(" Bootstrap Process")]),t._v(" "),a("p",[t._v("Before the genesis of a new chain, there must be a bootstrap node to generate network-wide secrets to fuel all the privacy features of the chain.")]),t._v(" "),a("h2",{attrs:{id:"consensus-seed"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#consensus-seed"}},[t._v("#")]),t._v(" "),a("code",[t._v("consensus_seed")])]),t._v(" "),a("ul",[a("li",[t._v("Create a remote attestation proof that the node's Enclave is genuine.")]),t._v(" "),a("li",[t._v("Generate inside the Enclave a true random 256 bits seed: "),a("code",[t._v("consensus_seed")]),t._v(".")]),t._v(" "),a("li",[t._v("Seal "),a("code",[t._v("consensus_seed")]),t._v(" with MRSIGNER to a local file: "),a("code",[t._v("$HOME/.sgx_secrets/consensus_seed.sealed")]),t._v(".")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 256 bits")]),t._v("\nconsensus_seed "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("true_random")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" bytes"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("seal")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MRSIGNER"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" consensus_seed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  to_file"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"$HOME/.sgx_secrets/consensus_seed.sealed"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"key-derivation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#key-derivation"}},[t._v("#")]),t._v(" Key Derivation")]),t._v(" "),a("p",[t._v("TODO reasoning")]),t._v(" "),a("ul",[a("li",[t._v("Key Derivation inside the Enclave is done deterministically using HKDF-SHA256 "),a("a",{attrs:{href:"https://tools.ietf.org/html/rfc5869#section-2",target:"_blank",rel:"noopener noreferrer"}},[t._v("[1]"),a("OutboundLink")],1),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/HKDF",target:"_blank",rel:"noopener noreferrer"}},[t._v("[2]"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("li",[t._v("The HKDF-SHA256 "),a("a",{attrs:{href:"https://tools.ietf.org/html/rfc5869#section-3.1",target:"_blank",rel:"noopener noreferrer"}},[t._v("salt"),a("OutboundLink")],1),t._v(" is chosen to be Bitcoin's halving block hash.")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("hkdf_salt "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x000000000000000000024bead8df69990852c202db0e0097c1a12ea637d7e96d")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("ul",[a("li",[t._v("Using HKDF-SHA256, "),a("code",[t._v("hkdf_salt")]),t._v(" and "),a("code",[t._v("consensus_seed")]),t._v(", derive the following keys:")])]),t._v(" "),a("h3",{attrs:{id:"consensus-seed-exchange-privkey"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#consensus-seed-exchange-privkey"}},[t._v("#")]),t._v(" "),a("code",[t._v("consensus_seed_exchange_privkey")])]),t._v(" "),a("ul",[a("li",[a("code",[t._v("consensus_seed_exchange_privkey")]),t._v(": A curve25519 private key. Will be used to derive encryption keys in order to securely share "),a("code",[t._v("consensus_seed")]),t._v(" with new nodes in the network.")]),t._v(" "),a("li",[t._v("From "),a("code",[t._v("consensus_seed_exchange_privkey")]),t._v(" calculate "),a("code",[t._v("consensus_seed_exchange_pubkey")]),t._v(".")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("consensus_seed_exchange_privkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hkdf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  salt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" hkdf_salt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ikm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" consensus_seed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uint8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 256 bits")]),t._v("\n\nconsensus_seed_exchange_pubkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("calculate_curve25519_pubkey")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  consensus_seed_exchange_privkey\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"consensus-io-exchange-privkey"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#consensus-io-exchange-privkey"}},[t._v("#")]),t._v(" "),a("code",[t._v("consensus_io_exchange_privkey")])]),t._v(" "),a("ul",[a("li",[a("code",[t._v("consensus_io_exchange_privkey")]),t._v(": A curve25519 private key. Will be used to derive encryption keys in order to decrypt transaction inputs and encrypt transaction outputs.")]),t._v(" "),a("li",[t._v("From "),a("code",[t._v("consensus_io_exchange_privkey")]),t._v(" calculate "),a("code",[t._v("consensus_io_exchange_pubkey")]),t._v(".")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("consensus_io_exchange_privkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hkdf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  salt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" hkdf_salt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ikm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" consensus_seed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uint8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 256 bits")]),t._v("\n\nconsensus_io_exchange_pubkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("calculate_curve25519_pubkey")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  consensus_io_exchange_privkey\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"consensus-state-ikm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#consensus-state-ikm"}},[t._v("#")]),t._v(" "),a("code",[t._v("consensus_state_ikm")])]),t._v(" "),a("ul",[a("li",[a("code",[t._v("consensus_state_ikm")]),t._v(": An input keyring material (IKM) for HKDF-SHA256 to derive encryption keys for contracts' state.")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("consensus_state_ikm "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hkdf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  salt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" hkdf_salt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ikm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" consensus_seed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uint8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 256 bits")]),t._v("\n")])])]),a("h3",{attrs:{id:"consensus-callback-secret"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#consensus-callback-secret"}},[t._v("#")]),t._v(" "),a("code",[t._v("consensus_callback_secret")])]),t._v(" "),a("ul",[a("li",[a("code",[t._v("consensus_callback_secret")]),t._v(": A curve25519 private key. Will be used to create callback signatures when contracts call other contracts.")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("consensus_state_ikm "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hkdf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  salt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" hkdf_salt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ikm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" consensus_seed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uint8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 256 bits")]),t._v("\n")])])]),a("h2",{attrs:{id:"bootstrap-process-epilogue"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bootstrap-process-epilogue"}},[t._v("#")]),t._v(" Bootstrap Process Epilogue")]),t._v(" "),a("p",[t._v("TODO reasoning")]),t._v(" "),a("ul",[a("li",[t._v("Seal "),a("code",[t._v("consensus_seed")]),t._v(" to disk at "),a("code",[t._v("$HOME/.sgx_secrets/consensus_seed.sealed")]),t._v(".")]),t._v(" "),a("li",[t._v("Publish to "),a("code",[t._v("genesis.json")]),t._v(":\n"),a("ul",[a("li",[t._v("The remote attestation proof that the Enclave is genuine.")]),t._v(" "),a("li",[a("code",[t._v("consensus_seed_exchange_pubkey")])]),t._v(" "),a("li",[a("code",[t._v("consensus_io_exchange_pubkey")])])])])]),t._v(" "),a("h1",{attrs:{id:"node-startup"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-startup"}},[t._v("#")]),t._v(" Node Startup")]),t._v(" "),a("p",[t._v("When a full node resumes its participation in the network, it reads "),a("code",[t._v("consensus_seed")]),t._v(" from "),a("code",[t._v("$HOME/.sgx_secrets/consensus_seed.sealed")]),t._v(" and again does "),a("a",{attrs:{href:"#Key-Derivation"}},[t._v("key derivation")]),t._v(" as outlined above.")]),t._v(" "),a("h1",{attrs:{id:"new-node-registration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#new-node-registration"}},[t._v("#")]),t._v(" New Node Registration")]),t._v(" "),a("p",[t._v("A new node wants to join the network as a full node.")]),t._v(" "),a("h2",{attrs:{id:"on-the-new-node"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#on-the-new-node"}},[t._v("#")]),t._v(" On the new node")]),t._v(" "),a("p",[t._v("TODO reasoning")]),t._v(" "),a("ul",[a("li",[t._v("Verify the remote attestation proof of the bootstrap node from "),a("code",[t._v("genesis.json")]),t._v(".")]),t._v(" "),a("li",[t._v("Create a remote attestation proof that the node's Enclave is genuine.")]),t._v(" "),a("li",[t._v("Generate inside the node's Enclave a true random curve25519 private key: "),a("code",[t._v("registration_privkey")]),t._v(".")]),t._v(" "),a("li",[t._v("From "),a("code",[t._v("registration_privkey")]),t._v(" calculate "),a("code",[t._v("registration_pubkey")]),t._v(".")]),t._v(" "),a("li",[t._v("Send an "),a("code",[t._v("secretcli tx register auth")]),t._v(" transaction with the following inputs:\n"),a("ul",[a("li",[t._v("The remote attestation proof that the node's Enclave is genuine.")]),t._v(" "),a("li",[a("code",[t._v("registration_pubkey")])]),t._v(" "),a("li",[t._v("256 bits true random "),a("code",[t._v("nonce")])])])])]),t._v(" "),a("h2",{attrs:{id:"on-the-consensus-layer-inside-the-enclave-of-every-full-node"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#on-the-consensus-layer-inside-the-enclave-of-every-full-node"}},[t._v("#")]),t._v(" On the consensus layer, inside the Enclave of every full node")]),t._v(" "),a("p",[t._v("TODO reasoning")]),t._v(" "),a("ul",[a("li",[t._v("Receive the "),a("code",[t._v("secretcli tx register auth")]),t._v(" transaction.")]),t._v(" "),a("li",[t._v("Verify the remote attestation proof that the new node's Enclave is genuine.")])]),t._v(" "),a("h3",{attrs:{id:"seed-exchange-key"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#seed-exchange-key"}},[t._v("#")]),t._v(" "),a("code",[t._v("seed_exchange_key")])]),t._v(" "),a("p",[t._v("TODO reasoning")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("seed_exchange_key")]),t._v(": An "),a("a",{attrs:{href:"https://tools.ietf.org/html/rfc5297",target:"_blank",rel:"noopener noreferrer"}},[t._v("AES-128-SIV"),a("OutboundLink")],1),t._v(" encryption key. Will be used to send "),a("code",[t._v("consensus_seed")]),t._v(" to the new node.")]),t._v(" "),a("li",[t._v("AES-128-SIV was chosen to prevent IV misuse by client libraries.\n"),a("ul",[a("li",[t._v("https://tools.ietf.org/html/rfc5297")]),t._v(" "),a("li",[t._v("https://github.com/miscreant/meta")]),t._v(" "),a("li",[t._v("The input key is 256 bits, but half of it is used to derive the internal IV.")]),t._v(" "),a("li",[t._v("AES-SIV does not pad the cipertext, and this leaks information about the plaintext data, specifically its size.")])])]),t._v(" "),a("li",[a("code",[t._v("seed_exchange_key")]),t._v(" is derived the following way:\n"),a("ul",[a("li",[a("code",[t._v("seed_exchange_ikm")]),t._v(" is derived using "),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman",target:"_blank",rel:"noopener noreferrer"}},[t._v("ECDH"),a("OutboundLink")],1),t._v(" ("),a("a",{attrs:{href:"https://tools.ietf.org/html/rfc7748#section-6",target:"_blank",rel:"noopener noreferrer"}},[t._v("x25519"),a("OutboundLink")],1),t._v(") with "),a("code",[t._v("consensus_seed_exchange_privkey")]),t._v(" and "),a("code",[t._v("registration_pubkey")]),t._v(".")]),t._v(" "),a("li",[a("code",[t._v("seed_exchange_key")]),t._v(" is derived using HKDF-SHA256 from "),a("code",[t._v("seed_exchange_ikm")]),t._v(" and "),a("code",[t._v("nonce")]),t._v(".")])])])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("seed_exchange_ikm "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ecdh")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  privkey"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" consensus_seed_exchange_privkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  pubkey"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" registration_pubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 256 bits")]),t._v("\n\nseed_exchange_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hkdf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  salt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" hkdf_salt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ikm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("seed_exchange_ikm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nonce"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 256 bits")]),t._v("\n")])])]),a("h3",{attrs:{id:"sharing-consensus-seed-with-the-new-node"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sharing-consensus-seed-with-the-new-node"}},[t._v("#")]),t._v(" Sharing "),a("code",[t._v("consensus_seed")]),t._v(" with the new node")]),t._v(" "),a("p",[t._v("TODO reasoning")]),t._v(" "),a("ul",[a("li",[t._v("The output of the "),a("code",[t._v("secretcli tx register auth")]),t._v(" transaction is "),a("code",[t._v("consensus_seed")]),t._v(" encrypted with AES-128-SIV, "),a("code",[t._v("seed_exchange_key")]),t._v(" as the encryption key, using the public key of the registering node for the AD.")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("encrypted_consensus_seed "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_encrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" seed_exchange_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" consensus_seed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ad"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" new_node_public_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" encrypted_consensus_seed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"back-on-the-new-node-inside-its-enclave"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#back-on-the-new-node-inside-its-enclave"}},[t._v("#")]),t._v(" Back on the new node, inside its Enclave")]),t._v(" "),a("ul",[a("li",[t._v("Receive the "),a("code",[t._v("secretcli tx register auth")]),t._v(" transaction output ("),a("code",[t._v("encrypted_consensus_seed")]),t._v(").")])]),t._v(" "),a("h3",{attrs:{id:"seed-exchange-key-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#seed-exchange-key-2"}},[t._v("#")]),t._v(" "),a("code",[t._v("seed_exchange_key")])]),t._v(" "),a("p",[t._v("TODO reasoning")]),t._v(" "),a("ul",[a("li",[a("p",[a("code",[t._v("seed_exchange_key")]),t._v(": An AES-128-SIV encryption key. Will be used to decrypt "),a("code",[t._v("consensus_seed")]),t._v(".")])]),t._v(" "),a("li",[a("p",[a("code",[t._v("seed_exchange_key")]),t._v(" is derived the following way:")]),t._v(" "),a("ul",[a("li",[a("p",[a("code",[t._v("seed_exchange_ikm")]),t._v(" is derived using "),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman",target:"_blank",rel:"noopener noreferrer"}},[t._v("ECDH"),a("OutboundLink")],1),t._v(" ("),a("a",{attrs:{href:"https://tools.ietf.org/html/rfc7748#section-6",target:"_blank",rel:"noopener noreferrer"}},[t._v("x25519"),a("OutboundLink")],1),t._v(") with "),a("code",[t._v("consensus_seed_exchange_pubkey")]),t._v(" (public in "),a("code",[t._v("genesis.json")]),t._v(") and "),a("code",[t._v("registration_privkey")]),t._v(" (available only inside the new node's Enclave).")])]),t._v(" "),a("li",[a("p",[a("code",[t._v("seed_exchange_key")]),t._v(" is derived using HKDF-SHA256 with "),a("code",[t._v("seed_exchange_ikm")]),t._v(" and "),a("code",[t._v("nonce")]),t._v(".")])])])])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("seed_exchange_ikm "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ecdh")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  privkey"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" registration_privkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  pubkey"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" consensus_seed_exchange_pubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// from genesis.json")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 256 bits")]),t._v("\n\nseed_exchange_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hkdf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  salt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" hkdf_salt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ikm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("seed_exchange_ikm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nonce"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 256 bits")]),t._v("\n")])])]),a("h3",{attrs:{id:"decrypting-encrypted-consensus-seed"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#decrypting-encrypted-consensus-seed"}},[t._v("#")]),t._v(" Decrypting "),a("code",[t._v("encrypted_consensus_seed")])]),t._v(" "),a("p",[t._v("TODO reasoning")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("encrypted_consensus_seed")]),t._v(" is encrypted with AES-128-SIV, "),a("code",[t._v("seed_exchange_key")]),t._v(" as the encryption key and the public key of the registering node as the "),a("code",[t._v("ad")]),t._v(" as the decryption additional data.")]),t._v(" "),a("li",[t._v("The new node now has all of these^ parameters inside its Enclave, so it's able to decrypt "),a("code",[t._v("consensus_seed")]),t._v(" from "),a("code",[t._v("encrypted_consensus_seed")]),t._v(".")]),t._v(" "),a("li",[t._v("Seal "),a("code",[t._v("consensus_seed")]),t._v(" to disk at "),a("code",[t._v("$HOME/.sgx_secrets/consensus_seed.sealed")]),t._v(".")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("consensus_seed "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_decrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" seed_exchange_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" encrypted_consensus_seed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ad"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" new_node_public_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("seal")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MRSIGNER"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" consensus_seed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  to_file"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"$HOME/.sgx_secrets/consensus_seed.sealed"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"new-node-registration-epilogue"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#new-node-registration-epilogue"}},[t._v("#")]),t._v(" New Node Registration Epilogue")]),t._v(" "),a("p",[t._v("TODO reasoning")]),t._v(" "),a("ul",[a("li",[t._v("The new node can now do "),a("a",{attrs:{href:"#key-derivation"}},[t._v("key derivation")]),t._v(" to get all the required network-wide secrets in order participate in blocks execution and validation.")]),t._v(" "),a("li",[t._v("After a machine/process reboot, the node can go through the "),a("a",{attrs:{href:"#node-startup"}},[t._v("node startup process")]),t._v(" again.")])]),t._v(" "),a("h1",{attrs:{id:"contracts-state-encryption"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#contracts-state-encryption"}},[t._v("#")]),t._v(" Contracts State Encryption")]),t._v(" "),a("p",[t._v("TODO reasoning")]),t._v(" "),a("ul",[a("li",[t._v("While executing a function call inside the Enclave as part of a transaction, the contract code can call "),a("code",[t._v("write_db(field_name, value)")]),t._v(", "),a("code",[t._v("read_db(field_name)")]),t._v(" and "),a("code",[t._v("remove_db(field_name)")]),t._v(".")]),t._v(" "),a("li",[t._v("Contracts' state is stored on-chain inside a key-value store, thus the "),a("code",[t._v("field_name")]),t._v(" must remain constant between calls.")]),t._v(" "),a("li",[a("code",[t._v("encryption_key")]),t._v(" is derived using HKDF-SHA256 from:\n"),a("ul",[a("li",[a("code",[t._v("consensus_state_ikm")])]),t._v(" "),a("li",[a("code",[t._v("field_name")])]),t._v(" "),a("li",[a("code",[t._v("contract_key")])])])]),t._v(" "),a("li",[a("code",[t._v("ad")]),t._v(" (Additional Data) is used to prevent leaking information about the same value written to the same key at different times.")])]),t._v(" "),a("h2",{attrs:{id:"contract-key"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#contract-key"}},[t._v("#")]),t._v(" "),a("code",[t._v("contract_key")])]),t._v(" "),a("ul",[a("li",[a("code",[t._v("contract_key")]),t._v(" is a concatenation of two values: "),a("code",[t._v("signer_id || authenticated_contract_key")]),t._v(".")]),t._v(" "),a("li",[t._v("Its purpose is to make sure that each contract have a unique unforgeable encryption key.\n"),a("ul",[a("li",[t._v("Unique: Make sure the state of two contracts with the same code is different.")]),t._v(" "),a("li",[t._v("Unforgeable: Make sure a malicious node runner won't be able to locally encrypt transactions with it's own encryption key and then decrypt the resulting state with the fake key.")])])]),t._v(" "),a("li",[t._v("When a contract is deployed (i.e., on contract init), "),a("code",[t._v("contract_key")]),t._v(" is generated inside the Enclave as follows:")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("signer_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sha256")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg_sender"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" block_height"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nauthentication_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hkdf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  salt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" hkdf_salt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  info"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"contract_key"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ikm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("consensus_state_ikm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" signer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nauthenticated_contract_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hmac_sha256")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" authentication_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" code_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ncontract_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("signer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" authenticated_contract_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("ul",[a("li",[t._v("Every time a contract execution is called, "),a("code",[t._v("contract_key")]),t._v(" should be sent to the Enclave.")]),t._v(" "),a("li",[t._v("In the Enclave, the following verification needs to happen:")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("signer_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" contract_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nexpected_contract_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" contract_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nauthentication_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hkdf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  salt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" hkdf_salt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  info"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"contract_key"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ikm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("consensus_state_ikm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" signer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ncalculated_contract_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hmac_sha256")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" authentication_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" code_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("calculated_contract_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" expected_contract_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"write-db-field-name-value"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#write-db-field-name-value"}},[t._v("#")]),t._v(" write_db(field_name, value)")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("encryption_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hkdf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  salt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" hkdf_salt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ikm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("consensus_state_ikm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" field_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" contract_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nencrypted_field_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_encrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" encryption_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" field_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ncurrent_state_ciphertext "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("internal_read_db")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("encrypted_field_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("current_state_ciphertext "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// field_name doesn't yet initialized in state")]),t._v("\n  ad "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sha256")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("encrypted_field_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// read previous_ad, verify it, calculate new ad")]),t._v("\n  previous_ad "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" current_state_ciphertext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// first 32 bytes/256 bits")]),t._v("\n  current_state_ciphertext "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" current_state_ciphertext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// skip first 32 bytes")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_decrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" encryption_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" current_state_ciphertext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    ad"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" previous_ad"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// just to authenticate previous_ad")]),t._v("\n  ad "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sha256")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("previous_ad"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nnew_state_ciphertext "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_encrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" encryption_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ad"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ad"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nnew_state "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ad"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" new_state_ciphertext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("internal_write_db")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("encrypted_field_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" new_state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"read-db-field-name"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#read-db-field-name"}},[t._v("#")]),t._v(" read_db(field_name)")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("encryption_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hkdf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  salt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" hkdf_salt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ikm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("consensus_state_ikm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" field_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" contract_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nencrypted_field_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_encrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" encryption_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" field_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ncurrent_state_ciphertext "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("internal_read_db")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("encrypted_field_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("current_state_ciphertext "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// field_name doesn't yet initialized in state")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// read ad, verify it")]),t._v("\nad "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" current_state_ciphertext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// first 32 bytes/256 bits")]),t._v("\ncurrent_state_ciphertext "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" current_state_ciphertext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// skip first 32 bytes")]),t._v("\ncurrent_state_plaintext "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_decrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" encryption_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" current_state_ciphertext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ad"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ad"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" current_state_plaintext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"remove-db-field-name"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#remove-db-field-name"}},[t._v("#")]),t._v(" remove_db(field_name)")]),t._v(" "),a("p",[t._v("Very similar to "),a("code",[t._v("read_db")]),t._v(".")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("encryption_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hkdf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  salt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" hkdf_salt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ikm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("consensus_state_ikm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" field_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" contract_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nencrypted_field_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_encrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" encryption_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" field_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("internal_remove_db")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("encrypted_field_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h1",{attrs:{id:"transaction-encryption"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#transaction-encryption"}},[t._v("#")]),t._v(" Transaction Encryption")]),t._v(" "),a("p",[t._v("TODO reasoning")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("tx_encryption_key")]),t._v(": An AES-128-SIV encryption key. Will be used to encrypt tx inputs and decrypt tx outputs.\n"),a("ul",[a("li",[a("code",[t._v("tx_encryption_ikm")]),t._v(" is derived using "),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman",target:"_blank",rel:"noopener noreferrer"}},[t._v("ECDH"),a("OutboundLink")],1),t._v(" ("),a("a",{attrs:{href:"https://tools.ietf.org/html/rfc7748#section-6",target:"_blank",rel:"noopener noreferrer"}},[t._v("x25519"),a("OutboundLink")],1),t._v(") with "),a("code",[t._v("consensus_io_exchange_pubkey")]),t._v(" and "),a("code",[t._v("tx_sender_wallet_privkey")]),t._v(" (on the sender's side).")]),t._v(" "),a("li",[a("code",[t._v("tx_encryption_ikm")]),t._v(" is derived using "),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman",target:"_blank",rel:"noopener noreferrer"}},[t._v("ECDH"),a("OutboundLink")],1),t._v(" ("),a("a",{attrs:{href:"https://tools.ietf.org/html/rfc7748#section-6",target:"_blank",rel:"noopener noreferrer"}},[t._v("x25519"),a("OutboundLink")],1),t._v(") with "),a("code",[t._v("consensus_io_exchange_privkey")]),t._v(" and "),a("code",[t._v("tx_sender_wallet_pubkey")]),t._v(" (inside the Enclave of every full node).")])])]),t._v(" "),a("li",[a("code",[t._v("tx_encryption_key")]),t._v(" is derived using HKDF-SHA256 with "),a("code",[t._v("tx_encryption_ikm")]),t._v(" and a random number "),a("code",[t._v("nonce")]),t._v(". This is to prevent using the same key for the same tx sender multiple times.")]),t._v(" "),a("li",[t._v("The input ("),a("code",[t._v("msg")]),t._v(") to the contract is always prepended with the sha256 hash of the contract's code.\n"),a("ul",[a("li",[t._v("This is meant to prevent replaying an encrypted input of a legitimate contract to a malicious contract and asking the malicious contract to decrypt the input. In this attack example the output will still be encrypted with a "),a("code",[t._v("tx_encryption_key")]),t._v(" that only the original sender knows, but the malicious contract can be written to save the decrypted input to its state and then via a getter with no access control retrieve the encrypted input.")])])])]),t._v(" "),a("h2",{attrs:{id:"input"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#input"}},[t._v("#")]),t._v(" Input")]),t._v(" "),a("h3",{attrs:{id:"on-the-transaction-sender"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#on-the-transaction-sender"}},[t._v("#")]),t._v(" On the transaction sender")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("tx_encryption_ikm "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ecdh")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  privkey"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" tx_sender_wallet_privkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  pubkey"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" consensus_io_exchange_pubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// from genesis.json")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 256 bits")]),t._v("\n\nnonce "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("true_random")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" bytes"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ntx_encryption_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hkdf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  salt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" hkdf_salt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ikm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tx_encryption_ikm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nonce"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 256 bits")]),t._v("\n\nad "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nonce"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tx_sender_wallet_pubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ncodeHash "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("toHexString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sha256")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("contract_code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nencrypted_msg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_encrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" tx_encryption_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("codeHash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ad"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ad"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ntx_input "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ad"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" encrypted_msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"on-the-consensus-layer-inside-the-enclave-of-every-full-node-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#on-the-consensus-layer-inside-the-enclave-of-every-full-node-2"}},[t._v("#")]),t._v(" On the consensus layer, inside the Enclave of every full node")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("nonce "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tx_input"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 32 bytes")]),t._v("\ntx_sender_wallet_pubkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tx_input"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 32 bytes, compressed curve25519 public key")]),t._v("\nencrypted_msg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tx_input"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ntx_encryption_ikm "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ecdh")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  privkey"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" consensus_io_exchange_privkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  pubkey"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" tx_sender_wallet_pubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 256 bits")]),t._v("\n\ntx_encryption_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hkdf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  salt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" hkdf_salt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ikm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tx_encryption_ikm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nonce"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 256 bits")]),t._v("\n\ncodeHashAndMsg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_decrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" tx_encryption_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" encrypted_msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ncodeHash "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" codeHashAndMsg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("codeHash "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("toHexString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sha256")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("contract_code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nmsg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" codeHashAndMsg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"output"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#output"}},[t._v("#")]),t._v(" Output")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("The output must be a valid JSON object, as it is passed to multiple mechanisms for final processing:")]),t._v(" "),a("ul",[a("li",[t._v("Logs are treated as Tendermint events")]),t._v(" "),a("li",[t._v("Messages can be callbacks to another contract call or contract init")]),t._v(" "),a("li",[t._v("Messages can also instruct sending funds from the contract's wallet")]),t._v(" "),a("li",[t._v("There's a data section which is free-form bytes to be interpreted by the client (or dApp)")]),t._v(" "),a("li",[t._v("And there's also an error section")])])]),t._v(" "),a("li",[a("p",[t._v("Therefore the output must be partially encrypted.")])]),t._v(" "),a("li",[a("p",[t._v("An example output for an execution:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ok"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"messages"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"type"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Send"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"to"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"..."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"amount"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"..."')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wasm"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"execute"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"msg"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{\\"banana\\":1,\\"papaya\\":2}"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// need to encrypt this value")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"contract_addr"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"aaa"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"callback_code_hash"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"bbb"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"send"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"amount"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"denom"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"uscrt"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wasm"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"instantiate"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"msg"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{\\"water\\":1,\\"fire\\":2}"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// need to encrypt this value")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"code_id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"123"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"callback_code_hash"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ccc"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"send"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"amount"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"denom"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"uscrt"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"log"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"key"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"action"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// need to encrypt this value")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"value"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"transfer"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// need to encrypt this value")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"key"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sender"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// need to encrypt this value")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"value"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"secret1v9tna8rkemndl7cd4ahru9t7ewa7kdq87c02m2"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// need to encrypt this value")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"key"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"recipient"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// need to encrypt this value")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"value"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"secret1f395p0gg67mmfd5zcqvpnp9cxnu0hg6rjep44t"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// need to encrypt this value")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"data"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"bla bla"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// need to encrypt this value")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("Notice on a "),a("code",[t._v("Contract")]),t._v(" message, the "),a("code",[t._v("msg")]),t._v(" value should be the same "),a("code",[t._v("msg")]),t._v(" as in our "),a("code",[t._v("tx_input")]),t._v(", so we need to prepend the "),a("code",[t._v("nonce")]),t._v(" and "),a("code",[t._v("tx_sender_wallet_pubkey")]),t._v(" just like we did on the tx sender above.")])]),t._v(" "),a("li",[a("p",[t._v("On a "),a("code",[t._v("Contract")]),t._v(" message, we also send a "),a("code",[t._v("callback_signature")]),t._v(", so we can later on verify the parameters sent to the enclave:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("callback_signature = sha256(consensus_callback_secret | calling_contract_addr | encrypted_msg | funds_to_send)\n")])])]),a("p",[t._v("For more on that, "),a("RouterLink",{attrs:{to:"/dev/privacy-model-of-secret-contracts.html#verified-values-during-contract-execution"}},[t._v("read here")]),t._v(".")],1)]),t._v(" "),a("li",[a("p",[t._v("For the rest of the encrypted outputs we only need to send the ciphertext, as the tx sender can get "),a("code",[t._v("consensus_io_exchange_pubkey")]),t._v(" from "),a("code",[t._v("genesis.json")]),t._v(" and "),a("code",[t._v("nonce")]),t._v(" from the "),a("code",[t._v("tx_input")]),t._v(" that is attached to the "),a("code",[t._v("tx_output")]),t._v(".")])]),t._v(" "),a("li",[a("p",[t._v("An example output with an error:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"err"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{\\"watermelon\\":6,\\"coffee\\":5}"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// need to encrypt this value")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("An example output for a query:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ok"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{\\"answer\\":42}"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// need to encrypt this value")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])])]),t._v(" "),a("h3",{attrs:{id:"on-the-consensus-layer-inside-the-enclave-of-every-full-node-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#on-the-consensus-layer-inside-the-enclave-of-every-full-node-3"}},[t._v("#")]),t._v(" On the consensus layer, inside the Enclave of every full node")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// already have from tx_input:")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// - tx_encryption_key")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// - nonce")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" output"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"err"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"string"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  encrypted_err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_encrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" tx_encryption_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" output"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"err"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  output"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"err"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("base64_encode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("encrypted_err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// needs to be a JSON string")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" output"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ok"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"string"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// query")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// output["ok"] is handled the same way as output["err"]...')]),t._v("\n  encrypted_query_result "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_encrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" tx_encryption_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" output"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ok"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  output"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ok"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("base64_encode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("encrypted_query_result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// needs to be a JSON string")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" output"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ok"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"object"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// init or execute")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// external query is the same, but happens mid-run and not as an output")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("m "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" output"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ok"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"messages"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"type"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Instantiate"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"type"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Execute"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      encrypted_msg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_encrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" tx_encryption_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"callback_code_hash"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"msg"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// base64_encode because needs to be a string")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// also turns into a tx_input so we also need to prepend nonce and tx_sender_wallet_pubkey")]),t._v("\n      m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"msg"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("base64_encode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nonce"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tx_sender_wallet_pubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" encrypted_msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("l "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" output"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ok"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"log"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// l["key"] is handled the same way as output["err"]...')]),t._v("\n    encrypted_log_key_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_encrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" tx_encryption_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"key"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"key"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("base64_encode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("encrypted_log_key_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// needs to be a JSON string")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// l["value"] is handled the same way as output["err"]...')]),t._v("\n    encrypted_log_value "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_encrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" tx_encryption_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"value"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"value"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("base64_encode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("encrypted_log_value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// needs to be a JSON string")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// output["ok"]["data"] is handled the same way as output["err"]...')]),t._v("\n  encrypted_output_data "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_encrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" tx_encryption_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" output"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ok"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"data"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  output"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ok"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"data"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("base64_encode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("encrypted_output_data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// needs to be a JSON string")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" output"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"back-on-the-transaction-sender"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#back-on-the-transaction-sender"}},[t._v("#")]),t._v(" Back on the transaction sender")]),t._v(" "),a("ul",[a("li",[t._v("The transaction output is written to the chain")]),t._v(" "),a("li",[t._v("Only the wallet with the right "),a("code",[t._v("tx_sender_wallet_privkey")]),t._v(" can derive "),a("code",[t._v("tx_encryption_key")]),t._v(", so for everyone else it will just be encrypted.")]),t._v(" "),a("li",[t._v("Every encrypted value can be decrypted the following way:")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// output["err"]')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// output["ok"]["data"]')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// output["ok"]["log"][i]["key"]')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// output["ok"]["log"][i]["value"]')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// output["ok"] if input is a query')]),t._v("\n\nencrypted_bytes "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("base64_encode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("encrypted_output"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("aes_128_siv_decrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" tx_encryption_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" encrypted_bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("ul",[a("li",[t._v("For "),a("code",[t._v('output["ok"]["messages"][i]["type"] == "Contract"')]),t._v(", "),a("code",[t._v('output["ok"]["messages"][i]["msg"]')]),t._v(" will be decrypted in "),a("a",{attrs:{href:"#on-the-consensus-layer-inside-the-enclave-of-every-full-node-1"}},[t._v("this")]),t._v(" manner by the consensus layer when it handles the contract callback.")])]),t._v(" "),a("h1",{attrs:{id:"blockchain-upgrades"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#blockchain-upgrades"}},[t._v("#")]),t._v(" Blockchain Upgrades")]),t._v(" "),a("p",[t._v("TODO")]),t._v(" "),a("h1",{attrs:{id:"theoretical-attacks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#theoretical-attacks"}},[t._v("#")]),t._v(" Theoretical Attacks")]),t._v(" "),a("p",[t._v("TODO add more")]),t._v(" "),a("h2",{attrs:{id:"deanonymizing-with-ciphertext-byte-count"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deanonymizing-with-ciphertext-byte-count"}},[t._v("#")]),t._v(" Deanonymizing with ciphertext byte count")]),t._v(" "),a("p",[t._v('No encryption padding, so a value of e.g. "yes" or "no" can be deanonymized by its byte count.')]),t._v(" "),a("h2",{attrs:{id:"two-contracts-with-the-same-contract-key-could-deanonymize-each-other-s-states"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#two-contracts-with-the-same-contract-key-could-deanonymize-each-other-s-states"}},[t._v("#")]),t._v(" Two contracts with the same "),a("code",[t._v("contract_key")]),t._v(" could deanonymize each other's states")]),t._v(" "),a("p",[t._v("If an attacker can create a contract with the same "),a("code",[t._v("contract_key")]),t._v(" as another contract, the state of the original contract can potentially be deanonymized.")]),t._v(" "),a("p",[t._v("For example, an original contract with a permissioned getter, such that only whitelisted addresses can query the getter. In the malicious contract the attacker can set themselves as the owner and ask the malicious contract to decrypt the state of the original contract via that permissioned getter.")]),t._v(" "),a("h2",{attrs:{id:"tx-replay-attacks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tx-replay-attacks"}},[t._v("#")]),t._v(" Tx Replay attacks")]),t._v(" "),a("p",[t._v("After a contract runs on the chain, an attacker can sync up a node up to a specific block in the chain, and then call into the enclave with the same authenticated user inputs that were given to the enclave on-chain, but out-of-order, or omit selected messages. A contract that does not anticipate or protect against this might end up de-anonymizing the information provided by users. For example, in a naive voting contract (or other personal data collection algorithm), we can de-anonymize a voter by re-running the vote without the target's request, and analyze the difference in final results.")]),t._v(" "),a("h2",{attrs:{id:"more-advanced-tx-replay-attacks-search-to-decision-for-millionaire-s-problem"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#more-advanced-tx-replay-attacks-search-to-decision-for-millionaire-s-problem"}},[t._v("#")]),t._v(" More Advanced Tx Replay attacks -- search to decision for Millionaire's problem")]),t._v(" "),a("p",[t._v("This attack provides a specific example of a TX replay attack extracting the full information of a client based on replaying a TX.")]),t._v(" "),a("p",[t._v("Specifically, assume for millionaire's that you have a contract where one person inputs their amount of money, then the other person does, then the contract sends them both a single bit saying who has more -- this is the simplest implementation for Millionaire's problem-solving. As person 2, binary search the interval of possible money amounts person 1 could have -- say you know person 1 has less than N dollars. First, query with N/2 as your value with your node detached from the wider network, get the single bit out (whether the true value is higher or lower), then repeat by re-syncing your node and calling in.\nBy properties of binary search, in log(n) tries (where n is the size of the interval) you'll have the exact value of person 1's input.")]),t._v(" "),a("p",[t._v("The naive solution to this is requiring the node to successfully broadcast the data of person 1 and person 2 to the network before revealing an answer (which is an implicit heartbeat test, that also ensures the transaction isn't replay-able), but even that's imperfect since you can reload the contract and replay the network state up to that broadcast, restoring the original state of the contract, then perform the attack with repeated rollbacks.")]),t._v(" "),a("p",[t._v("Assaf: You could maybe implement the contract with the help of a 3rd party. I.e. the 2 players send their amounts. When the 3rd party sends an approval tx only then the 2 players can query the result. However, this is not good UX.")]),t._v(" "),a("h2",{attrs:{id:"partial-storage-rollback-during-contract-runtime"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#partial-storage-rollback-during-contract-runtime"}},[t._v("#")]),t._v(" Partial storage rollback during contract runtime")]),t._v(" "),a("p",[t._v("Our current schema can verify that when reading from a field in storage, the value received from the host has been written by the same contract instance to the same field in storage. BUT we can not (yet) verify that the value is the most recent value that was stored there. This means that a malicious host can (offline) run a transaction, and then selectively provide outdated values for some fields of the storage. In the worst case, this can cause a contract to expose old secrets with new permissions, or new secrets with old permissions. The contract can protect against this by either (e.g.) making sure that pieces of information that have to be synced with each other are saved under the same field (so they are never observed as desynchronized) or (e.g.) somehow verify their validity when reading them from two separate fields of storage.")]),t._v(" "),a("h2",{attrs:{id:"tx-outputs-can-leak-data"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tx-outputs-can-leak-data"}},[t._v("#")]),t._v(" Tx outputs can leak data")]),t._v(" "),a("p",[t._v("E.g. a dev writes a contract with 2 functions, the first one always outputs 3 events and the second one always outputs 4 events. By counting the number of output events an attacker can know which function was invoked. Also applies with deposits, callbacks and transfers.")])])}),[],!1,null,null,null);s.default=e.exports}}]);